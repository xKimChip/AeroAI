<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Flight Data</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Socket-IO client -->
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js"></script>

  <style>
    html,body{height:100%;margin:0;font-family:sans-serif;background:#000}
    #status{padding:8px 12px;background:#eee}
    #map{height:80vh;width:100%}

    #threatBox{
      position:absolute;bottom:12px;left:12px;z-index:900;
      background:rgba(255,255,255,.9);border:1px solid #aaa;
      border-radius:6px;max-height:300px;overflow-y:auto;
      box-shadow:0 2px 6px rgba(0,0,0,.3)}
    #threatBox table{border-collapse:collapse;font-size:.8rem}
    #threatBox th,#threatBox td{padding:4px 6px;border:1px solid #ccc;text-align:center}
    #threatBox thead{background:#f8d7da}
    .threatRow{color:#b30000;font-weight:600}

    /* tiny legend circles */
    #legend{margin:6px 0;font-size:.75rem;text-align:left}
    #legend span{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:4px}

    /* Leaflet div icon override – removes default img shadow box */
    .planeIcon{background:none;border:none}
  </style>
</head>
<body>
  <div id="status">Waiting for data…</div>
  <div id="map"></div>

  <!-- threat card -->
  <div id="threatBox">
    <div id="legend">
      <span style="background:red"></span> Anomaly&nbsp;&nbsp;
      <span style="background:#00aaff"></span> Normal
    </div>
    <table>
      <thead><tr>
        <th>IDENT</th><th>Score</th><th>Lat</th><th>Lon</th><th>Desc.</th>
      </tr></thead>
      <tbody id="tBody"></tbody>
    </table>
  </div>

  <script>
    /* ------- dark basemap -------- */
    const map = L.map('map', { preferCanvas:true }).setView([0,0], 2);
    L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      { attribution:'&copy; OpenStreetMap &amp; CartoDB' }
    ).addTo(map);

    /* helper: returns a rotated airplane icon */
    function makePlaneIcon(color, headingDeg){
      // simple arrow/plane SVG path
      const path = "M21 16v-2l-8-5V3.5a1.5 1.5 0 0 0-3 0V9l-8 5v2l8-2.5V18l-2 1.5V21l4-1 4 1v-1.5L13 18v-4.5l8 2.5z";
      const svg = `
        <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'
             fill='${color}' style='transform:rotate(${headingDeg}deg)'>
          <path d='${path}'/>
        </svg>`;
      return L.divIcon({
        className:'planeIcon',
        html:svg,
        iconSize:[20,20],
        iconAnchor:[10,10]   // center the icon
      });
    }

    /* ------- Socket-IO -------- */
    const socket = io();

    socket.on('connect', () => {
      document.getElementById('status').textContent =
        'Connected – waiting for flight data…';
    });

    socket.on('new_data', raw => {
      const f = { ...raw };
      // cast numeric-like strings ➜ numbers
      ['lat','lon','alt','gs','heading','anomaly_score']
        .forEach(k => f[k] = parseFloat(f[k]));
      const ident    = f.ident ?? 'n/a';
      const desc     = f.anomaly_description ?? '–';
      const isThreat = f.anomaly_score > 0;

      /* add plane marker */
      const iconColor = isThreat ? 'red' : '#00aaff';
      L.marker([f.lat, f.lon], {
        icon: makePlaneIcon(iconColor, f.heading)
      })
      .addTo(map)
      .bindPopup(
        `<b>${ident}</b><br>
         Alt: ${f.alt}<br>
         GS: ${f.gs}<br>
         Heading: ${f.heading}<br>
         Anomaly: ${f.anomaly_score}<br>
         ${isThreat ? desc : ''}`
      );

      /* status line */
      document.getElementById('status').textContent =
        `${new Date().toLocaleTimeString()} – ${
          isThreat ? 'THREAT DETECTED' : 'normal traffic'
        }`;

      /* threat table */
      if (isThreat) {
        const row = document.createElement('tr');
        row.className = 'threatRow';
        row.innerHTML = `
          <td>${ident}</td>
          <td>${f.anomaly_score.toFixed(2)}</td>
          <td>${f.lat.toFixed(2)}</td>
          <td>${f.lon.toFixed(2)}</td>
          <td>${desc}</td>`;
        const tbody = document.getElementById('tBody');
        tbody.prepend(row);
        if (tbody.rows.length > 25) tbody.deleteRow(25); // keep table short
      }
    });

    socket.on('disconnect', () => {
      document.getElementById('status').textContent =
        'Disconnected – retrying…';
    });
  </script>
</body>
</html>
